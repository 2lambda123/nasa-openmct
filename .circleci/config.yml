version: 2.1
executors:
  linux:
    docker:
      - image: mcr.microsoft.com/playwright:focal
orbs:
  node: circleci/node@4.9.0
  browser-tools: circleci/browser-tools@1.2.3
jobs:
  npm-audit:
    executor: linux
    steps:
      - checkout
      - node/install:
          install-npm: true
          node-version: lts/fermium
      - run: npm install
      - run: npm audit --audit-level=low
  lint:
    parameters:
      node-version:
        type: string
    executor: linux
    environment:
      NODE_ENV: development
      NODE_PARAM_NPM_VERSION: 6.14.12
    steps:
      - checkout
      - restore_cache:
          key: deps-{{ .Branch }}--<< parameters.node-version >>--{{ checksum "package.json" }}
      - node/install:
          install-npm: true
          node-version: << parameters.node-version >>
      - run: npm install
      - save_cache:
          key: deps-{{ .Branch }}--<< parameters.node-version >>--{{ checksum "package.json" }}
          paths:
            - ~/.npm
            - ~/.cache
            - node_modules
      - run: npm run lint
  test:
    parameters:
      node-version:
        type: string
      browser:
        type: string
    executor: linux
    environment:
      NODE_ENV: development # Needed to ensure 'dist' folder created
      NODE_PARAM_NPM_VERSION: 6.14.12
    steps:
      - checkout
      - restore_cache:
          key: deps-{{ .Branch }}--<< parameters.node-version >>--{{ checksum "package.json" }}
      - node/install:
          install-npm: true
          node-version: << parameters.node-version >>
          npm-version: 6.14.12
          #NODE_PARAM_NPM_VERSION: v6.14.12
      - run: npm install
      - when:
          condition:
            equal: [ "FirefoxESR", <<parameters.browser>> ]
          steps:
            - browser-tools/install-firefox:
                version: "91.2.0esr" #https://archive.mozilla.org/pub/firefox/releases/          
      - when:
          condition:
            equal: [ "FirefoxHeadless", <<parameters.browser>> ]
          steps:
            - browser-tools/install-firefox
      - when:
          condition:
            equal: [ "ChromeHeadless", <<parameters.browser>> ]
          steps:
            - browser-tools/install-chrome:
                replace-existing: false
      - save_cache:
          key: deps-{{ .Branch }}--<< parameters.node-version >>--{{ checksum "package.json" }}
          paths:
            - ~/.npm
            - ~/.cache
            - node_modules
      - when:
          condition: << parameters.browser >> #Truthy evaluation to only run when browser is specified
          steps:
            - run: npm run test:coverage -- --browsers=<<parameters.browser>>
            - store_test_results:
                path: dist/reports/tests/
            - store_artifacts:
                path: dist/reports/
  e2e:
    parameters:
      node-version:
        type: string
      suite:
        type: string
    executor: linux
    environment:
      NODE_ENV: development # Needed if playwright is in `devDependencies`
    steps:
      - checkout
      - restore_cache:
          key: deps-{{ .Branch }}--<< parameters.node-version >>--{{ checksum "package.json" }}
      - node/install:
          install-npm: true
          node-version: << parameters.node-version >>
      - run: npm install
      - save_cache:
          key: deps-{{ .Branch }}--<< parameters.node-version >>--{{ checksum "package.json" }}
          paths:
            - ~/.npm
            - ~/.cache
            - node_modules
      - run: npx playwright install
      - run: npm run test:e2e:<<parameters.suite>>
      - store_test_results:
          path: test-results/results.xml
      - store_artifacts:
          path: test-results
workflows:
  matrix-tests:
    jobs:
      - lint:             
          name: node10-build-lint
          node-version: lts/dubnium
      - test:
          name: node12-chrome
          node-version: lts/erbium
          browser: ChromeHeadless
      - test: 
          name: node14-chrome
          node-version: lts/fermium
          browser: ChromeHeadless
          post-steps:
            - run:
                command:
                  curl -Os https://uploader.codecov.io/latest/linux/codecov;chmod +x codecov;./codecov 
      - e2e:
          name: e2e-smoke
          node-version: lts/fermium
          suite: ci
  nightly:
    jobs:
      - test:
          name: node10-chrome-nightly
          node-version: lts/dubnium
          browser: ChromeHeadless
      - test:
          name: node12-firefoxESR-nightly
          node-version: lts/erbium
          browser: FirefoxESR
      - test:
          name: node12-chrome-nightly
          node-version: lts/erbium
          browser: ChromeHeadless
      - test:
          name: node14-firefox-nightly
          node-version: lts/fermium
          browser: FirefoxHeadless
      - test: 
          name: node14-chrome-nightly
          node-version: lts/fermium
          browser: ChromeHeadless
      - npm-audit
      - e2e:
          name: e2e-full-nightly
          node-version: lts/fermium
          suite: full
    triggers:
      - schedule:
          cron: "0 0 * * *"
          filters:
            branches:
              only:
                - master
