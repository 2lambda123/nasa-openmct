version: 2.1
executors:
  linux:
    docker:
      - image: cimg/base:2020.01
  macos: &macos-executor
    macos:
      xcode: "11.4"
orbs:
  node: circleci/node@4.5.1
  browser-tools: circleci/browser-tools@1.1.3
jobs:
  test:
    parameters:
      node-version:
        type: string
      browser:
        type: string
    executor: <<parameters.platform>>
    steps:
      - checkout
      - restore_cache:
          key: deps-{{ .Branch }}-{{ checksum "package.json" }}
      - node/install:
          node-version: << parameters.node-version >>
      - node/install-packages:
          override-ci-command: npm install
      - browser-tools/install-firefox:
          version: "78.11.0esr" #https://archive.mozilla.org/pub/firefox/releases/
      - browser-tools/install-chrome:
          replace-existing: false
      - save_cache:
          key: deps-{{ .Branch }}-{{ checksum "package.json" }}
          paths:
            - ~/.npm
            - ~/.cache
            - ~/bin/google-chrome
            - ~/bin/firefox
      - run:
          ls -latR
      - run: npm run test:coverage -- --browsers=<<parameters.browser>>
      - store_test_results:
          path: dist/reports/tests/
      - store_artifacts:
          path: dist/reports/
workflows:
  matrix-tests:
    jobs:
      - test:
          name: node10-chrome
          node-version: lts/dubnium
          browser: ChromeHeadless
          platform: linux
      - test:
          name: node12-firefoxESR
          node-version: lts/erbium
          browser: FirefoxHeadless
          platform: linux
      - test:
          name: node14-chrome
          node-version: lts/fermium
          browser: ChromeHeadless
          platform: macos
      #- test:
      #    name: node16-canary
      #    node-version: '16'
      #    browser: ChromeCanaryHeadless


